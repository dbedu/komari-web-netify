name: Build and Release Assets

on:
  release:
    types: [created] # 仅在创建新的 Release 时触发

jobs:
  build_and_upload: # 合并了构建和上传的作业
    runs-on: ubuntu-latest
    permissions: # 需要权限来写入 Release 附件
      contents: write # 或者 specific permissions like `release: write` if more granular control is needed. For `actions/upload-release-asset` this is often sufficient.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build project
        run: npm run build
        
      - name: Archive and upload build artifacts
        run: |
          # Create zip file more efficiently
          zip -r dist-release.zip dist/
          
          # Upload using GitHub CLI (more reliable than deprecated action)
          gh release upload ${{ github.event.release.tag_name }} dist-release.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}